#!/usr/bin/env bash
set -euo pipefail

TARGETS="<%= @targets.flatten.join(' ') -%>"
MIRROR_ROOT="<%= @mirror_root -%>"
ALERT_HOSTNAME="<%= @alert_hostname %>"
ALERT_SOURCE_IP_ADDRESS="<%= @ipaddress_eth0 %>"
SYNC_SERVICE_DESC="<%= @sync_service_desc %>"

DESTINATION_REGION=eu-west-2
GOVUK_APP_DOMAIN=$(cat /etc/govuk/env.d/GOVUK_APP_DOMAIN)
STATIC_HOSTNAME="static.${GOVUK_APP_DOMAIN}"
GOVUK_WEBSITE_ROOT=$(cat /etc/govuk/env.d/GOVUK_WEBSITE_ROOT)
GOVUK_WEBSITE_DIR="${GOVUK_WEBSITE_ROOT##https://}"
PROGRAM_NAME=$(basename "$0")
WEBSITE_MIRROR_DIR="${MIRROR_ROOT}/${GOVUK_WEBSITE_DIR}"

S5CMD_URL="https://github.com/peak/s5cmd/releases/download/v2.0.0/s5cmd_2.0.0_Linux-64bit.tar.gz"
S5CMD=/usr/local/bin/s5cmd

# Nagios defaults, assume failed
EXIT_CODE=1
EXIT_MESSAGE="WARNING: GOV.UK mirror synchronisation failed."

function log() {
  logger -p "$1" -t "${PROGRAM_NAME}" "$2"
}

function log_exit_status() {
  # shellcheck disable=SC2317
  log "user.info" "$EXIT_MESSAGE Exit code was $EXIT_CODE"
}

trap log_exit_status EXIT

function install_s5cmd() {
  tmpdir=$(mktemp -d)
  trap 'rm -fr $tmpdir' EXIT INT QUIT TERM

  (
    cd "$tmpdir"
    curl -fsL "${S5CMD_URL}" | tar -zxf - s5cmd
    sudo cp s5cmd "${S5CMD}"
  )
}

if [ -z "${TARGETS}" ]; then
  log "user.info" "No mirror targets received"
fi

if [ ! -d "${MIRROR_ROOT}" ]; then
  log "user.info" "No mirror root specified or directory does not exist: ${MIRROR_ROOT}"
fi

if [ -z "${GOVUK_APP_DOMAIN}" ]; then
  log "user.info" "Couldn't find GOVUK_APP_DOMAIN"
fi

function get_error_page() {
  # Grab the 503 error page
  log "user.info" "Grabbing the latest error page"

  sudo -u deploy mkdir -p "${WEBSITE_MIRROR_DIR}/error/"
  sudo -u deploy curl -sf "https://${STATIC_HOSTNAME}/templates/503.html.erb" -o "${WEBSITE_MIRROR_DIR}/error/503.html"
}

function write_timestamp() {
  echo "upload_time=$(date +%s)" > timestamps.txt
  sudo mv timestamps.txt "${WEBSITE_MIRROR_DIR}"
}

[[ -x "${S5CMD}" ]] || install_s5cmd
log "user.info" "Starting to synchronise GOV.UK to mirror: ${TARGETS}"
get_error_page
write_timestamp
START_UPLOAD=$(date +%s%3N)

function do_sync() {
  # With s3cmd/s5cmd sync, the target needs to end with /
  [[ ${TARGET} == */ ]] || TARGET="${TARGET}/"

  /usr/local/bin/govuk_setenv s3_sync_mirror "${S5CMD}" --log error sync \
      --destination-region "${DESTINATION_REGION}" \
      --exclude lost+found "${MIRROR_ROOT}/" "${TARGET}"
}

EXIT_CODE=0
for TARGET in ${TARGETS}; do
  log "user.info" "Started uploading to ${TARGET}"

  if do_sync; then
    log "user.info" "Finished uploading to mirror ${TARGET}"
  else
    EXIT_CODE=1
    log "user.crit" "Uploading mirror ${TARGET} failed with exit code: $EXIT_CODE"
  fi
done

STOP_UPLOAD=$(date +%s%3N)
DURATION_UPLOAD=$((STOP_UPLOAD - START_UPLOAD))

echo "govuk.app.sync_mirror.upload_duration:$DURATION_UPLOAD|ms" | nc -q 1 -u localhost 8125
log "user.info" "Finished synchronising to GOV.UK mirrors"

if [[ $EXIT_CODE -eq 0 ]]; then
  MESSAGE="OK: GOV.UK mirror synchronised successfully in ${DURATION_UPLOAD} ms"
  echo -e "${ALERT_SOURCE_IP_ADDRESS}\t${SYNC_SERVICE_DESC}\t${EXIT_CODE}\t${MESSAGE}" |
      /usr/sbin/send_nsca -H "${ALERT_HOSTNAME}" > /dev/null
fi
exit $EXIT_CODE
