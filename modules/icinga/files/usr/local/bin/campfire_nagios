#!/usr/bin/env ruby
require 'rubygems'
require 'optparse'
begin
  if Gem.available?('tinder')
    require 'tinder'
  else
    puts "tinder not installed, please \"gem install tinder\""
    exit 1
  end
end
 
options = OpenStruct.new
options.message   = ""
options.room      = ""
options.subdomain = ""
options.token     = ""


optparse = OptionParser.new do |o| 
    o.banner = "#{File.basename($0)} -s \"<subdomain\" -t \"<token>\" -r \"<room>\" -m \"<message>\""
 
    o.on('-m', '--message <message>', 'Message for Campfire') do |message|
        options.message << message
    end                                                                                                   
    o.on('-s', '--subdomain <subdomain>', 'Subdomain for Campfire') do |subdomain|
        options.subdomain << subdomain
    end                                                                                                   
    o.on('-t', '--token <token>', 'Token for Campfire Auth') do |token|
        options.token << token
    end                                                                                                   
    o.on('-r', '--room <room>', 'Room to notify') do |room|
        options.room << room
    end                                                                                                   
 
    o.separator ""
 
    o.on_tail('-h', '--help', 'Display this help screen') do
        puts o
        exit 1
    end 
end
 
optparse.parse!

if (options.subdomain == "") or
   (options.room == "") or 
   (options.token == "") or
   (options.message == "")
  puts "ERROR: Options missing, see \"#{File.basename($0)} -h\" for details"
  exit 1
end

begin 
  campfire = Tinder::Campfire.new(options.subdomain, 
                                :ssl => true,
                                :token => options.token)
  room = campfire.find_room_by_name options.room
rescue Tinder::AuthenticationFailed
  puts "ERROR: Authentication failed for https://#{options.subdomain}.campfirenow.com/ with token #{options.token}"
  exit 1
end

if room == nil
  puts "ERROR: Room #{options.room} does not exist"
  exit 1
else
  room.speak "#{options.message}"
end
