---
- job:
    name: clear-cdn-cache
    display-name: Clear CDN cache
    project-type: freestyle
    description: >
      Clears the CDN cache for the 10 most popular pages on GOV.UK.
    properties:
      - build-discarder:
          num-to-keep: 30
    builders:
      - shell: |
          #!/usr/bin/env bash

          set -ex

          declare -a hostnames=(
            "<%= @website_root_url -%>"
            "<%= @assets_root_url -%>"
          )

          # 10 most popular pages based on GA 1-year stats
          declare -a paths=(
            "/"
            "/check-mot-history"
            "/coronavirus"
            "/get-coronavirus-test"
            "/log-in-register-hmrc-online-services"
            "/report-covid19-result"
            "/search/all"
            "/sign-in-universal-credit"
            "/sold-bought-vehicle"
            "/vehicle-tax"
          )

          for node in `govuk_node_list -c cache`; do
            for hostname in "${hostnames[@]}"; do
              for path in "${paths[@]}"; do
                ssh deploy@$node "curl -s -X PURGE $hostname$path"
              done
            done
          done
    wrappers:
      - ansicolor:
          colormap: xterm
