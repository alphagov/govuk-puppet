---
- job:
    name: clear-cdn-cache
    display-name: Clear CDN cache
    project-type: freestyle
    description: >
      Clears the CDN cache for the 10 most popular pages on GOV.UK.
    properties:
      - build-discarder:
          num-to-keep: 30
    builders:
      - shell: |
          #!/usr/bin/env ruby
          require 'net/http'
          require 'uri'
          require 'json'


          hostnames = [
            @website_root_url,
            @assets_root_url
          ]

          uri = URI('https://www.gov.uk/api/search.json?fields=title&order=-popularity')
          res = Net::HTTP.get_response(uri)

          body = JSON.parse(res.body)
          paths = body["results"].map {|x| x["_id"]}

          nodes = `govuk_node_list -c cache`.split("\n")

          nodes.each do |node|
            hostnames.each do |hostname|
              paths.each do |path|
                uri = URI(hostname+path)
                request = Net::HTTPGenericRequest.new("PURGE", false, false, uri)
                response = Net::HTTP.start(uri.hostname, uri.port, {use_ssl: true}) do |http|
                  http.request(request)
                end
              end
            end
          end
    wrappers:
      - ansicolor:
          colormap: xterm
