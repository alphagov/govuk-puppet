---
- scm:
    name: smokey-repo
    scm:
        - git:
            url: git@github.com:alphagov/smokey.git
            branches:
              - master

- job:
    name: run-smokey-after-deploy
    display-name: "Run smoke tests (Smokey) after deploy"
    description: "This job is configured to run the smoke tests (https://github.com/alphagov/smokey) after applications are deployed. When the tests fail it sends a message to the #2ndline Slack channel."
    project-type: freestyle
    scm:
      - smokey-repo
    properties:
      - slack:
          notify-start: false
          notify-success: false
          notify-aborted: true
          notify-notbuilt: true
          notify-unstable: false
          notify-failure: true
          notify-backtonormal: false
          notify-repeatedfailure: false
          include-test-summary: false
    publishers:
      - slack:
          team-domain: <%= @slack_team_domain %>
          auth-token: <%= @environment_variables['SECOND_LINE_SLACK_AUTH_TOKEN']%>
          build-server-url: <%= @slack_build_server_url %>
          room: <%= @slack_room %>
    builders:
        - shell: |
            set +x
            export TARGET_PLATFORM=<%= @environment %>
            export AUTH_USERNAME='<%= @auth_username %>'
            export AUTH_PASSWORD='<%= @auth_password %>'
            export MYSQL_USERNAME=panopticon
            export EFG_DOMAIN='https://www.sflg.gov.uk'
            export EFG_USERNAME='<%= @efg_username %>'
            export EFG_PASSWORD='<%= @efg_password %>'
            export SIGNON_EMAIL='<%= @signon_email %>'
            export SIGNON_PASSWORD='<%= @signon_password %>'
            export BEARER_TOKEN=<%= @smokey_bearer_token %>
            export RATE_LIMIT_TOKEN=<%= @smokey_rate_limit_token %>
            export MYTASK=<%= @smokey_task %>
            set -x
            ./jenkins.sh
    wrappers:
        - ansicolor:
            colormap: xterm
