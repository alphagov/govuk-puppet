---
- scm:
    name: alphagov-deployment_Deploy_EFG_Rebuild
    scm:
        - git:
            url: git@github.com:alphagov/govuk-app-deployment.git
            branches:
              - master
            wipe-workspace: true

- job:
    name: Deploy_EFG_Rebuild
    display-name: Deploy_EFG_Rebuild
    project-type: freestyle
    description: "This job will also trigger a deploy of efg-training"
    properties:
        - github:
            url: https://github.com/alphagov/govuk-app-deployment
        - inject:
            properties-content: |
              TARGET_APPLICATION=efg-rebuild
    scm:
      - alphagov-deployment_Deploy_EFG_Rebuild
    builders:
        - shell: |
            #!/usr/bin/env bash
            export DEPLOY_TO="<%= @environment -%>"
            export DEPLOY_TASK="$DEPLOY_TASK"
            export TAG="$TAG"
            export ORGANISATION="<%= @environment -%>"
            export CI_DEPLOY_JENKINS_API_KEY="<%= @ci_deploy_jenkins_api_key -%>"

            if [ "$DEPLOY_FROM_GITHUB_ENTERPRISE" == "true" ]; then
              export GIT_ORIGIN_PREFIX="git@github.gds:gds-production-backup"
            fi

            ./jenkins.sh
    publishers:
        - trigger:
            project: run-smokey-after-deploy
        - trigger-parameterized-builds:
            - project: Deploy_App
              predefined-parameters: |
                TARGET_APPLICATION=efg-training-rebuild
                DEPLOY_TASK=deploy
                TAG=$TAG
                DEPLOY_FROM_GITHUB_ENTERPRISE=false
              condition: 'SUCCESS'
            - project: GDS_Production_Backup
              predefined-parameters: |
                TARGET_APPLICATION=$TARGET_APPLICATION
                TARGET_APPLICATION_GIT_REPO=$WORKSPACE/$TARGET_APPLICATION
              condition: 'UNSTABLE_OR_BETTER'
    wrappers:
        - ansicolor:
            colormap: xterm
        - build-name:
            name: '${ENV,var="TARGET_APPLICATION"} ${ENV,var="TAG"}'
    parameters:
        - choice:
            name: DEPLOY_TASK
            description: Capistrano task to run.
            choices:
                - deploy
                - deploy:migrate_and_hard_restart
                - deploy:migrations
                - deploy:hard_restart
        - string:
            name: TAG
            description: Git tag/committish to deploy.
            default: release
        - bool:
            name: DEPLOY_FROM_GITHUB_ENTERPRISE
            default: false
            description: Whether to deploy from GitHub Enterprise in case public GitHub is unavailable
