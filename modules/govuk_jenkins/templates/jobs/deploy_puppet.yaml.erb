---
- scm:
    name: deployment_Deploy_Puppet
    scm:
        - git:
            url: git@github.gds:gds/deployment.git
            branches:
              - master

- job:
    name: Deploy_Puppet
    display-name: Deploy Puppet
    project-type: freestyle
    description: "<a href='http://www.flickr.com/photos/fatty/9158066939/'><img src='https://farm3.staticflickr.com/2835/9158066939_374360ed56_n.jpg'></a><p>This job deploys the puppet release branch by default. To promote something into the release branch so it can be deployed to <%= @environment -%>, see the instructions on the <a href='https://ci.dev.publishing.service.gov.uk/job/Puppet_Promote_To_Release_Ready/'>Puppet_Promote_To_Release_Ready</a> job.</p>"
    <%- if @auth_token -%>
    auth-token: <%= @auth_token %>
    <%- end -%>
    properties:
        - github:
            url: https://github.gds/gds/deployment/
        - slack:
            notify-start: false
            notify-success: true
            notify-aborted: true
            notify-notbuilt: true
            notify-unstable: false
            notify-failure: true
            notify-backtonormal: false
            notify-repeatedfailure: false
            include-test-summary: false
    scm:
      - deployment_Deploy_Puppet
    builders:
        - shell: |
           sh -eu puppet/deploy.sh
    publishers:
        - trigger:
            project: run-smokey-after-deploy
        - trigger-parameterized-builds:
            - project: GDS_Production_Backup
              predefined-parameters: TARGET_APPLICATION_GIT_REPO=$WORKSPACE/puppet
              condition: 'UNSTABLE_OR_BETTER'
        - slack:
            team-domain: <%= @slack_team_domain %>
            auth-token: <%= @environment_variables['SECOND_LINE_SLACK_AUTH_TOKEN']%>
            build-server-url: <%= @slack_build_server_url %>
            room: <%= @slack_room %>
    wrappers:
        - ansicolor:
            colormap: xterm
        - build-name:
            name: '#${BUILD_NUMBER} ${ENV,var="TAG"}'
        - timestamps:
    parameters:
        - string:
            name: TAG
            description: Git tag/committish to deploy.
            default: <%= @commitish -%>
